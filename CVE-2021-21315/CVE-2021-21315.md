# CVE-2021-21315

* NodeJS组件systeminformation<5.3.1命令注入

## 简介

* sanitizeShellString方法过滤不当使得可以用数组绕过执行命令

### 缺陷函数

> si.inetChecksite 
>
> si.services
>
> ...

## 代码

* /systeminformation/lib/util.js

```js
function sanitizeShellString(str, strict = false) {
  const s = str || '';
  let result = '';
  for (let i = 0; i <= 2000; i++) {
    if (!(s[i] === undefined ||
      s[i] === '>' ||
      s[i] === '<' ||
      s[i] === '*' ||
      s[i] === '?' ||
      s[i] === '[' ||
      s[i] === ']' ||
      s[i] === '|' ||
      s[i] === '˚' ||
      s[i] === '$' ||
      s[i] === ';' ||
      s[i] === '&' ||
      s[i] === '(' ||
      s[i] === ')' ||
      s[i] === ']' ||
      s[i] === '#' ||
      s[i] === '\\' ||
      s[i] === '\t' ||
      s[i] === '\n' ||
      s[i] === '\'' ||
      s[i] === '`' ||
      s[i] === '"' ||
      strict && s[i] === ' ' ||
      strict && s[i] == '{' ||
      strict && s[i] == ')')) {
      result = result + s[i];
    }
  }
  return result;
}

```

* /systeminformation/lib/process.js

```js
if (srvString !== '' && srvs.length > 0) {
            exec(
                comm + ' | grep -v grep | grep -iE "' + srvString + '"', 
                { maxBuffer: 1024 * 20000 }, 
                function (error, stdout) {...}
                )
}
```

## POC

https://github.com/ForbiddenProgrammer/CVE-2021-21315-PoC



## 修复方案

* 对参数类型进行更加严格的检查



